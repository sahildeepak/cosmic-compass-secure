<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Compass</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #818CF8; border-radius: 2px; }
        ::-webkit-scrollbar-track { background: #0F172A; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* Darkest Navy */
            color: #E2E8F0; /* Light text */
            min-height: 100vh;
        }
        /* Mobile-first main container styling */
        .main-container {
            max-width: 640px;
            margin: 0 auto;
            padding-bottom: 72px; /* Space for fixed bottom nav */
        }
        /* Custom slow spin for the initial loading screen logo */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }
        /* Enhanced Hero SVG styling */
        .cosmic-hero {
            filter: drop-shadow(0 0 10px rgba(129, 140, 248, 0.5)); /* Subtle neon glow */
        }
    </style>
</head>
<body>

    <div id="app" class="main-container flex flex-col min-h-screen">
        <!-- HEADER -->
        <header class="sticky top-0 bg-gray-900 shadow-xl p-4 flex justify-between items-center z-10">
            <h1 class="text-2xl font-extrabold text-indigo-400">Cosmic Compass</h1>
            <div class="flex items-center space-x-2">
                <!-- Language Selector -->
                <select id="language-selector" class="bg-gray-800 border border-gray-700 text-indigo-300 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2">
                    <option value="en">English</option>
                    <option value="hi">हिन्दी (Hindi)</option>
                </select>
                <!-- Profile Button -->
                <button id="profile-btn" class="text-indigo-300 hover:text-indigo-100 transition duration-150 p-2 rounded-full bg-gray-800" onclick="showProfileModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M12 2a10 10 0 0 0 9.071 5.378 10 10 0 0 1-5.698 12.33 10 10 0 0 0-3.373-1.077c-.504-.085-1.15-.027-1.503.208-.475.313-.604.912-.34 1.488.267.591.956.883 1.57.653A10 10 0 0 0 12 2z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="content-area" class="flex-grow p-4">
             <!-- THIS IS THE NEW DEFAULT SPLASH SCREEN. IT WILL BE REPLACED ONCE FIREBASE IS READY. -->
             <div id="initial-splash" class="text-center p-6 space-y-8 mt-10">
                <div class="cosmic-hero mx-auto w-56 h-56 relative animate-pulse">
                    <svg viewBox="0 0 100 100" class="w-full h-full">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#3730A3" stroke-width="1"/>
                        <circle cx="50" cy="50" r="35" fill="none" stroke="#4F46E5" stroke-width="1.5" stroke-dasharray="1 3"/>
                        <circle cx="50" cy="50" r="8" fill="#FBBF24"/>
                        <polygon points="50,10 53,50 50,90 47,50" fill="#E0E7FF" transform="rotate(-15, 50, 50)"/>
                    </svg>
                </div>
                <p class="text-lg text-gray-300 font-medium animate-pulse" data-lang-key="initializing">Initializing secure connection...</p>
            </div>
        </main>

        <!-- FIXED BOTTOM NAVIGATION -->
        <nav class="fixed bottom-0 left-0 right-0 bg-gray-900 shadow-2xl border-t border-indigo-700/50 z-20">
            <div class="max-w-md mx-auto flex justify-around items-center h-16">
                <button class="nav-item flex flex-col items-center p-2 text-sm transition-colors duration-200 text-gray-400 hover:text-indigo-300" data-view="home" onclick="switchView('home')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span class="mt-1" data-lang-key="nav_home">Home</span>
                </button>
                <button class="nav-item flex flex-col items-center p-2 text-sm transition-colors duration-200 text-gray-400 hover:text-indigo-300" data-view="chart" onclick="switchView('chart')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="12" cy="12" r="10"/><path d="M12 2v10"/><path d="M18.4 6.6l-2.1 2.1"/><path d="M5.6 6.6l2.1 2.1"/></svg>
                    <span class="mt-1" data-lang-key="nav_chart">Chart</span>
                </button>
                <button class="nav-item flex flex-col items-center p-2 text-sm transition-colors duration-200 text-gray-400 hover:text-pink-300" data-view="health" onclick="switchView('health')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M20.5 2L15 6.5l-3-3L2 12l9.5 9.5 3-3L17.5 20l4.5-5.5z"/><path d="M12 12l-7-7"/></svg>
                    <span class="mt-1" data-lang-key="nav_health">Health</span>
                </button>
                <button class="nav-item flex flex-col items-center p-2 text-sm transition-colors duration-200 text-gray-400 hover:text-orange-300" data-view="matching" onclick="switchView('matching')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    <span class="mt-1" data-lang-key="nav_matching">Matching</span>
                </button>
                <button class="nav-item flex flex-col items-center p-2 text-sm transition-colors duration-200 text-gray-400 hover:text-teal-300" data-view="history" onclick="switchView('history')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 21a9 9 0 0 0 9-9h-2a7 7 0 0 1-7 7V12h-2V7h2V5H9a9 9 0 0 0-9 9z"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span class="mt-1" data-lang-key="nav_history">History</span>
                </button>
            </div>
        </nav>

        <!-- Modals and Overlays -->
        <div id="modal-container"></div>
        <div id="loading-overlay" class="fixed inset-0 bg-gray-900/70 flex items-center justify-center hidden z-50">
            <div class="flex flex-col items-center p-8 bg-gray-800 rounded-2xl shadow-2xl border border-indigo-500 transform scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400 animate-spin-slow mb-4">
                    <path d="M12 2a10 10 0 0 0 9.071 5.378 10 10 0 0 1-5.698 12.33 10 10 0 0 0-3.373-1.077c-.504-.085-1.15-.027-1.503.208-.475.313-.604.912-.34 1.488.267.591.956.883 1.57.653A10 10 0 0 0 12 2z"/>
                    <path d="M12 2v20"/><path d="M4.22 4.22l15.56 15.56M4.22 19.78l15.56-15.56"/>
                    <path d="M22 12h-3"/><path d="M5 12h-3"/><path d="M12 5V2"/><path d="M12 22v-3"/>
                </svg>
                <p class="mt-3 text-indigo-300 font-semibold text-lg" data-lang-key="loading_generating">Generating Cosmic Insight...</p>
            </div>
        </div>
    </div>

    <!-- 
      *** ALL SCRIPT LOGIC IS NOW IN THIS SINGLE MODULE ***
      This fixes the race condition by ensuring Firebase loads and 
      initializes *before* any app logic (like switchView) runs.
    -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Firebase Variables ---
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let activeSnapshotUnsubscribe = null;
        
        // --- Translation System ---
        const translations = {
            en: {
                initializing: "Initializing secure connection...",
                nav_home: "Home",
                nav_chart: "Chart",
                nav_health: "Health",
                nav_matching: "Matching",
                nav_history: "History",
                loading_generating: "Generating Cosmic Insight...",
                modal_loading: "Loading",
                modal_connecting: "Please wait while we connect to the server...",
                modal_success: "Success",
                modal_error: "Error",
                modal_profile_saved: "Your default birth details have been saved!",
                modal_profile_auth_wait: "Please wait for authentication to complete.",
                modal_profile_auth_error: "Failed to save profile. Please check console for details.",
                modal_delete_disabled: "Deleting history items is disabled to maintain code stability.",
                modal_ai_fail: "There was an error generating the reading: {error}. Please check your Netlify logs and Gemini API Key.",
                modal_input_required: "Input Required",
                modal_follow_up_missing: "Please type your follow-up question.",
                modal_context_missing: "Original reading context is missing.",
                modal_validation_error: "Validation Error",
                modal_validation_details: "Date of Birth, Time of Birth, and City are required.",
                modal_validation_partner1: "Please fill in all details for Partner 1.",
                modal_validation_partner2: "Please fill in all details for Partner 2.",
                auth_profile_title: "User Profile & Auth",
                auth_signed_in_as: "Signed in as:",
                auth_permanent_user: "Permanent User",
                auth_user_id: "User ID:",
                auth_sign_out: "Sign Out",
                auth_anonymous_user: "Anonymous User",
                auth_anonymous_desc: "Your history is currently saved locally. Sign in or Sign up below to save your data permanently!",
                auth_sign_in: "Sign In",
                auth_new_account: "New Account",
                auth_email: "Email",
                auth_password: "Password (6+ chars)",
                auth_sign_up: "Sign Up",
                auth_validation_fail: "Please enter a valid email and a password of at least 6 characters.",
                auth_success_signin: "Welcome Back! Successfully signed in as {email}.",
                auth_success_signup: "Account Created! Successfully created and signed in as {email}.",
                auth_fail: "Authentication Failed.",
                auth_fail_error: "Error: {error}",
                auth_signed_out: "Signed Out",
                auth_signed_out_desc: "You have been signed out. You are now an anonymous user.",
                profile_title: "Default Birth Details",
                profile_name: "Name",
                profile_dob: "Date of Birth",
                profile_tob: "Time of Birth",
                profile_city: "City/Location",
                profile_save: "Save Default Details",
                home_welcome: "Welcome to Cosmic Compass",
                home_desc: "Cosmic Compass provides personalized astrological insights powered by advanced analysis.",
                home_free: "⭐ This is a completely FREE service! ⭐",
                home_explore_title: "What you can explore:",
                home_explore_chart: "Comprehensive natal chart, annual forecasts, and specific life queries.",
                home_explore_health: "Astrological insights into your vitality, strengths, and holistic well-being.",
                home_explore_matching: "Detailed Kundali Matching (Ashtakoot Milan) to check compatibility.",
                home_explore_history: "Save and review your personalized readings (automatically saved to your private cloud history).",
                chart_title: "Natal Chart & Forecast",
                chart_desc: "Enter your birth details to receive a comprehensive analysis, annual forecast, or a specific query response.",
                chart_name_placeholder: "Name (e.g., Jane Doe)",
                chart_dob_placeholder: "Date of Birth",
                chart_tob_placeholder: "Time of Birth",
                chart_city_placeholder: "City (e.g., New York, NY)",
                chart_year_placeholder: "Annual Forecast Year (Optional)",
                chart_year_desc: "Focuses on major transits for the year.",
                chart_query_placeholder: "Specific Question (e.g., How will my career look next month?) - OPTIONAL",
                chart_query_desc: "Overrides Annual Prediction for a custom analysis.",
                chart_button: "Generate Reading",
                health_title: "Holistic Health Profile",
                health_desc: "Get an astrological perspective on your vitality, strengths, and areas for preventative care.",
                health_query_placeholder: "Specific Health Inquiry (e.g., Focus on my joints and energy levels) - OPTIONAL",
                health_query_desc: "The AI will focus its analysis on this area.",
                health_button: "Generate Health Profile",
                matching_title: "Kundali Matching (Compatibility)",
                matching_desc: "Enter the birth details for two people to generate a Kundali Matching (Ashtakoot Milan) report.",
                matching_p1_title: "Partner 1 (Your Details)",
                matching_p1_desc: "Your saved profile details are loaded here.",
                matching_p2_title: "Partner 2 Details",
                matching_p2_desc: "Enter the second person's birth details.",
                matching_button: "Generate Compatibility Report",
                history_title: "Reading History",
                history_desc: "Your personal archive of cosmic insights.",
                history_user_id: "User ID:",
                history_empty: "No readings saved yet. Generate one now!",
                history_reading_title: "Reading:",
                history_followup_title: "Follow-up: {question}",
                history_delete_button: "Delete History Item",
                output_followup_title: "Ask a Follow-up Question",
                output_followup_placeholder: "Ask a specific question based on the reading above...",
                output_followup_button: "Get Follow-up Answer",
                output_followup_question: "Your Question:",
                output_followup_response: "AI Response:",
                reading_title_health: "Holistic Health Profile",
                reading_title_forecast: "Annual Forecast ({year})",
                reading_title_query: "Targeted Chart Query",
                reading_title_natal: "Comprehensive Natal Chart Overview",
                reading_title_matching: "Kundali Matching Report",
                reading_subtitle_query: "Query: {query}",
                reading_subtitle_type: "{type}",
                reading_details: "Birth Details:",
                reading_details_p1: "Partner 1 Details:",
                reading_details_p2: "Partner 2 Details:",
                reading_details_name: "Name: {name}",
                reading_details_dob: "DOB: {dob}",
                reading_details_tob: "TOB: {tob}",
                reading_details_city: "City: {city}",
                auth_error_anon_fail: "Error: Could not authenticate with server. Please ensure **Anonymous Sign-In** is enabled in your Firebase project's Authentication settings.",
                auth_error_config_missing: "Error: Firebase configuration is missing. The app cannot start. Please paste your Firebase project config into the `index.html` file.",
            },
            hi: {
                initializing: "सुरक्षित कनेक्शन प्रारंभ किया जा रहा है...",
                nav_home: "मुख",
                nav_chart: "चार्ट",
                nav_health: "स्वास्थ्य",
                nav_matching: "मिलान",
                nav_history: "इतिहास",
                loading_generating: "ब्रह्मांडीय अंतर्दृष्टि उत्पन्न हो रही है...",
                modal_loading: "लोड हो रहा है",
                modal_connecting: "कृपया सर्वर से कनेक्ट होने तक प्रतीक्षा करें...",
                modal_success: "सफलता",
                modal_error: "त्रुटि",
                modal_profile_saved: "आपके डिफ़ॉल्ट जन्म विवरण सहेज लिए गए हैं!",
                modal_profile_auth_wait: "कृपया प्रमाणीकरण पूरा होने तक प्रतीक्षा करें।",
                modal_profile_auth_error: "प्रोफ़ाइल सहेजने में विफल। कृपया कंसोल जांचें।",
                modal_delete_disabled: "स्थिरता बनाए रखने के लिए इतिहास आइटम हटाना अक्षम है।",
                modal_ai_fail: "रीडिंग उत्पन्न करने में एक त्रुटि हुई: {error}। कृपया अपने नेटलिफाई लॉग और जेमिनी एपीआई कुंजी की जांच करें।",
                modal_input_required: "इनपुट आवश्यक है",
                modal_follow_up_missing: "कृपया अपना अनुवर्ती प्रश्न टाइप करें।",
                modal_context_missing: "मूल रीडिंग संदर्भ गायब है।",
                modal_validation_error: "सत्यापन त्रुटि",
                modal_validation_details: "जन्म तिथि, जन्म समय और शहर आवश्यक हैं।",
                modal_validation_partner1: "कृपया साथी 1 के लिए सभी विवरण भरें।",
                modal_validation_partner2: "कृपया साथी 2 के लिए सभी विवरण भरें।",
                auth_profile_title: "उपयोगकर्ता प्रोफ़ाइल और प्रामाणिकता",
                auth_signed_in_as: "इस रूप में साइन इन हैं:",
                auth_permanent_user: "स्थायी उपयोगकर्ता",
                auth_user_id: "उपयोगकर्ता आईडी:",
                auth_sign_out: "साइन आउट",
                auth_anonymous_user: "अज्ञात उपयोगकर्ता",
                auth_anonymous_desc: "आपका इतिहास वर्तमान में स्थानीय रूप से सहेजा गया है। अपना डेटा स्थायी रूप से सहेजने के लिए नीचे साइन इन या साइन अप करें!",
                auth_sign_in: "साइन इन",
                auth_new_account: "नया खाता",
                auth_email: "ईमेल",
                auth_password: "पासवर्ड (6+ अक्षर)",
                auth_sign_up: "साइन अप",
                auth_validation_fail: "कृपया एक मान्य ईमेल और कम से कम 6 अक्षरों का पासवर्ड दर्ज करें।",
                auth_success_signin: "वापसी पर स्वागत है! {email} के रूप में सफलतापूर्वक साइन इन किया।",
                auth_success_signup: "खाता बन गया! {email} के रूप में सफलतापूर्वक बनाया और साइन इन किया।",
                auth_fail: "प्रमाणीकरण विफल",
                auth_fail_error: "त्रुटि: {error}",
                auth_signed_out: "साइन आउट",
                auth_signed_out_desc: "आप साइन आउट हो गए हैं। अब आप एक अज्ञात उपयोगकर्ता हैं।",
                profile_title: "डिफ़ॉल्ट जन्म विवरण",
                profile_name: "नाम",
                profile_dob: "जन्म तिथि",
                profile_tob: "जन्म समय",
                profile_city: "शहर/स्थान",
                profile_save: "डिफ़ॉल्ट विवरण सहेजें",
                home_welcome: "कॉस्मिक कम्पास में आपका स्वागत है",
                home_desc: "कॉस्मिक कम्पास उन्नत विश्लेषण द्वारा संचालित व्यक्तिगत ज्योतिषीय अंतर्दृष्टि प्रदान करता है।",
                home_free: "⭐ यह एक पूरी तरह से मुफ़्त सेवा है! ⭐",
                home_explore_title: "आप क्या खोज सकते हैं:",
                home_explore_chart: "व्यापक जन्म चार्ट, वार्षिक पूर्वानुमान, और विशिष्ट जीवन प्रश्न।",
                home_explore_health: "आपकी जीवन शक्ति, शक्तियों और समग्र कल्याण में ज्योतिषीय अंतर्दृष्टि।",
                home_explore_matching: "संगतता की जांच के लिए विस्तृत कुंडली मिलान (अष्टकूट मिलान)।",
                home_explore_history: "अपनी व्यक्तिगत रीडिंग सहेजें और समीक्षा करें (स्वचालित रूप से आपके निजी क्लाउड इतिहास में सहेजा गया)।",
                chart_title: "जन्म चार्ट और पूर्वानुमान",
                chart_desc: "एक व्यापक विश्लेषण, वार्षिक पूर्वानुमान, या एक विशिष्ट प्रश्न प्रतिक्रिया प्राप्त करने के लिए अपना जन्म विवरण दर्ज करें।",
                chart_name_placeholder: "नाम (जैसे, जेन डो)",
                chart_dob_placeholder: "जन्म तिथि",
                chart_tob_placeholder: "जन्म समय",
                chart_city_placeholder: "शहर (जैसे, न्यूयॉर्क, एनवाई)",
                chart_year_placeholder: "वार्षिक पूर्वानुमान वर्ष (वैकल्पिक)",
                chart_year_desc: "वर्ष के लिए प्रमुख पारगमन पर केंद्रित है।",
                chart_query_placeholder: "विशिष्ट प्रश्न (जैसे, अगले महीने मेरा करियर कैसा दिखेगा?) - वैकल्पिक",
                chart_query_desc: "एक कस्टम विश्लेषण के लिए वार्षिक भविष्यवाणी को ओवरराइड करता है।",
                chart_button: "रीडिंग उत्पन्न करें",
                health_title: "समग्र स्वास्थ्य प्रोफ़ाइल",
                health_desc: "अपनी जीवन शक्ति, शक्तियों और निवारक देखभाल के क्षेत्रों पर ज्योतिषीय परिप्रेक्ष्य प्राप्त करें।",
                health_query_placeholder: "विशिष्ट स्वास्थ्य जांच (जैसे, मेरे जोड़ों और ऊर्जा स्तरों पर ध्यान केंद्रित करें) - वैकल्पिक",
                health_query_desc: "एआई इस क्षेत्र पर अपने विश्लेषण पर ध्यान केंद्रित करेगा।",
                health_button: "स्वास्थ्य प्रोफ़ाइल उत्पन्न करें",
                matching_title: "कुंडली मिलान (संगतता)",
                matching_desc: "कुंडली मिलान (अष्टकूट मिलान) रिपोर्ट तैयार करने के लिए दो लोगों के जन्म विवरण दर्ज करें।",
                matching_p1_title: "साथी 1 (आपका विवरण)",
                matching_p1_desc: "आपके सहेजे गए प्रोफ़ाइल विवरण यहाँ लोड किए गए हैं।",
                matching_p2_title: "साथी 2 विवरण",
                matching_p2_desc: "दूसरे व्यक्ति का जन्म विवरण दर्ज करें।",
                matching_button: "संगतता रिपोर्ट उत्पन्न करें",
                history_title: "रीडिंग इतिहास",
                history_desc: "ब्रह्मांडीय अंतर्दृष्टि का आपका व्यक्तिगत संग्रह।",
                history_user_id: "उपयोगकर्ता आईडी:",
                history_empty: "अभी तक कोई रीडिंग सहेजी नहीं गई है। अभी एक उत्पन्न करें!",
                history_reading_title: "रीडिंग:",
                history_followup_title: "अनुवर्ती: {question}",
                history_delete_button: "इतिहास आइटम हटाएं",
                output_followup_title: "एक अनुवर्ती प्रश्न पूछें",
                output_followup_placeholder: "ऊपर दी गई रीडिंग के आधार पर एक विशिष्ट प्रश्न पूछें...",
                output_followup_button: "अनुवर्ती उत्तर प्राप्त करें",
                output_followup_question: "आपका सवाल:",
                output_followup_response: "एआई प्रतिक्रिया:",
                reading_title_health: "समग्र स्वास्थ्य प्रोफ़ाइल",
                reading_title_forecast: "वार्षिक पूर्वानुमान ({year})",
                reading_title_query: "लक्षित चार्ट क्वेरी",
                reading_title_natal: "व्यापक जन्म चार्ट अवलोकन",
                reading_title_matching: "कुंडली मिलान रिपोर्ट",
                reading_subtitle_query: "क्वेरी: {query}",
                reading_subtitle_type: "{type}",
                reading_details: "जन्म विवरण:",
                reading_details_p1: "साथी 1 विवरण:",
                reading_details_p2: "साथी 2 विवरण:",
                reading_details_name: "नाम: {name}",
                reading_details_dob: "जन्म तिथि: {dob}",
                reading_details_tob: "जन्म समय: {tob}",
                reading_details_city: "शहर: {city}",
                auth_error_anon_fail: "त्रुटि: सर्वर से प्रमाणित नहीं हो सका। कृपया सुनिश्चित करें कि आपके फायरबेस प्रोजेक्ट की प्रमाणीकरण सेटिंग्स में **अज्ञात साइन-इन** सक्षम है।",
                auth_error_config_missing: "त्रुटि: फायरबेस कॉन्फ़िगरेशन गायब है। ऐप शुरू नहीं हो सकता। कृपया अपनी फायरबेस प्रोजेक्ट कॉन्फिग को `index.html` फ़ाइल में पेस्ट करें।",
            }
        };

        let currentLanguage = 'en';

        function translateUI(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            // Also translate dynamic placeholder text
            renderCurrentView();
        }


        // --- GLOBAL APP STATE ---
        state = {
            currentView: 'home', // Default view is 'home'
            userProfile: {
                name: '',
                dob: '',
                tob: '',
                city: ''
            },
            currentReading: null, // Stores the last generated reading details
            history: [],
            modalOpen: false
        };

        // --- UTILITY FUNCTIONS ---

        function t(key, params = {}) {
            let text = translations[currentLanguage][key] || translations['en'][key] || key;
            if (params) {
                Object.keys(params).forEach(paramKey => {
                    text = text.replace(`{${paramKey}}`, params[paramKey]);
                });
            }
            return text;
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
            document.querySelector('#loading-overlay p').textContent = t('loading_generating');
        }

        function showModal(titleKey, contentKey, type = 'info', contentParams = {}) {
            if (state.modalOpen) return; 
            
            const modalContainer = document.getElementById('modal-container');
            let color = type === 'error' ? 'bg-red-900 border-red-500' : 'bg-gray-800 border-indigo-500';
            let titleColor = type === 'error' ? 'text-red-400' : 'text-indigo-400';

            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40" onclick="closeModal()">
                    <div class="w-11/12 max-w-sm p-6 rounded-xl shadow-2xl ${color} border flex flex-col" style="max-height: 90vh;" onclick="event.stopPropagation()">
                        <h3 class="text-xl font-bold mb-4 ${titleColor}">${t(titleKey)}</h3>
                        <div class="text-sm text-gray-300 overflow-y-auto">${t(contentKey, contentParams)}</div>
                        <button class="mt-6 w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-200" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            state.modalOpen = true;
        }

        // --- FIREBASE / DATA MANAGEMENT ---
        async function loadUserProfile() {
            if (!userId || !db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                const profileQuery = query(
                    collection(db, 'artifacts', appId, 'users', userId, 'user_profile')
                );
                const snapshot = await getDocs(profileQuery);
                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data(); 
                    state.userProfile = {
                        name: data.name || '',
                        dob: data.dob || '',
                        tob: data.tob || '',
                        city: data.city || ''
                    };
                    console.log("Profile loaded:", state.userProfile);
                } else {
                    console.log("No user profile found, using defaults.");
                }
            } catch (e) {
                console.error("Error loading profile:", e);
            }
        }

        async function saveUserProfile(details) {
            if (!userId || !db) {
                showModal('modal_error', 'modal_profile_auth_wait', 'error');
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'user_profile', 'details'); 
            try {
                await setDoc(profileRef, details, { merge: true });
                state.userProfile = details;
                showModal('modal_success', 'modal_profile_saved');
                renderCurrentView(); 
            } catch (e) {
                console.error("Error saving profile:", e);
                showModal('modal_error', 'modal_profile_auth_error', 'error');
            }
        }
        
        function setupHistoryListener() {
            if (activeSnapshotUnsubscribe) {
                console.log("Detaching old history listener.");
                activeSnapshotUnsubscribe(); 
                activeSnapshotUnsubscribe = null;
            }
            if (!userId || !db) return;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const historyRef = collection(db, 'artifacts', appId, 'users', userId, 'astrology_readings');
            const q = query(historyRef); 
            activeSnapshotUnsubscribe = onSnapshot(q, (snapshot) => {
                const readings = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    readings.push({ id: doc.id, ...data });
                });
                readings.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                state.history = readings;
                if (state.currentView === 'history') {
                    renderHistory();
                }
            }, (error) => {
                console.error("Error listening to history:", error);
            });
            console.log("History listener active for user:", userId);
        }

        async function saveReading(readingData) {
            if (!userId || !db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const historyRef = collection(db, 'artifacts', appId, 'users', userId, 'astrology_readings');
            try {
                await addDoc(historyRef, {
                    ...readingData,
                    timestamp: Date.now(),
                    userId: userId 
                });
                console.log("Reading saved to history.");
            } catch (e) {
                console.error("Error saving reading:", e);
            }
        }

        async function deleteReading(id) {
             if (!userId || !db) return;
             const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
             try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'astrology_readings', id));
                console.log("Reading deleted.");
             } catch (e) {
                console.error("Error deleting reading:", e);
                showModal('modal_error', 'Could not delete reading.', 'error');
             }
        }
        
        // --- GEMINI API COMMUNICATION (SECURE PROXY) ---

        async function generateReading(birthDetails, userQuery, yearInput, readingType, previousReading = null, readingData, p2Details = null) {
            showLoading(true);
            
            const apiUrl = '/.netlify/functions/generateReading'; 
            const payload = {
                birthDetails,
                p2Details, // Add partner 2 details
                userQuery,
                yearInput,
                readingType,
                previousReading,
                language: currentLanguage // Pass the selected language
            };

            try {
                let response = null;
                let maxRetries = 3;
                let delay = 1000;
                let errorText = 'Proxy request failed after retries.';

                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break; 

                    if (response.status === 429 && i < maxRetries - 1) { 
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue; 
                    }
                    
                    errorText = `Proxy request failed with status: ${response.status}`;
                    try {
                        const rawError = await response.text(); 
                        try {
                            const errorResult = JSON.parse(rawError);
                            errorText = errorResult.error || rawError;
                        } catch (e) {
                            errorText = rawError; 
                        }
                    } catch (e) {
                        console.error("Could not read error response body:", e);
                    }
                    throw new Error(errorText); 
                }

                if (!response.ok) {
                    throw new Error(errorText);
                }

                const result = await response.json(); 
                
                if (result.error) {
                    throw new Error(result.error);
                }

                if (!previousReading) {
                    state.currentReading = {
                        title: readingData.title,
                        birthDetails: birthDetails,
                        p2Details: p2Details,
                        content: result.text,
                        type: readingType,
                        year: yearInput
                    };
                }
                
                return result.text;
            } catch (error) {
                console.error("AI Generation Error:", error);
                showModal('modal_error', 'modal_ai_fail', 'error', { error: error.message });
                return null;
            } finally {
                showLoading(false);
            }
        }

        // --- AUTH/PROFILE MODAL LOGIC ---
        function showProfileModal(requireAuth = false) {
            if (!isAuthReady) {
                showModal('modal_loading', 'modal_connecting', 'info');
                return;
            }
            const isAuthenticated = auth.currentUser && !auth.currentUser.isAnonymous;
            const profileContent = `
                ${isAuthenticated ? `
                    <div class="mb-4 text-sm">
                        <p class="font-semibold text-indigo-300" data-lang-key="auth_signed_in_as">${t('auth_signed_in_as')}</p>
                        <p class="text-gray-300 break-words">${auth.currentUser.email || t('auth_permanent_user')}</p>
                        <p class="text-xs text-gray-500 mt-1" data-lang-key="auth_user_id">${t('auth_user_id')} ${userId}</p>
                    </div>
                    ${renderProfileForm()}
                    <button class="mt-4 w-full py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-200" onclick="handleSignOut()" data-lang-key="auth_sign_out">${t('auth_sign_out')}</button>
                ` : `
                    <div class="text-center mb-6 p-4 bg-yellow-900/50 rounded-lg border border-yellow-700">
                        <p class="font-bold text-yellow-300 mb-2" data-lang-key="auth_anonymous_user">${t('auth_anonymous_user')}</p>
                        <p class="text-sm text-yellow-200" data-lang-key="auth_anonymous_desc">${t('auth_anonymous_desc')}</p>
                    </div>
                    ${renderAuthForm(true)}
                    <p class="text-center text-sm my-3 text-gray-400">- OR -</p>
                    ${renderAuthForm(false)}
                `}
            `;
            showModal('auth_profile_title', profileContent, 'info');
        }
        function renderAuthForm(isSignIn) {
            return `
                <form id="${isSignIn ? 'sign-in' : 'sign-up'}-form" class="space-y-3 p-4 border border-indigo-700/50 rounded-xl bg-gray-900/50 mb-4">
                    <h4 class="text-lg font-bold text-indigo-200" data-lang-key="${isSignIn ? 'auth_sign_in' : 'auth_new_account'}">${t(isSignIn ? 'auth_sign_in' : 'auth_new_account')}</h4>
                    <input type="email" id="${isSignIn ? 'sign-in' : 'sign-up'}-email" placeholder="${t('auth_email')}" required class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <input type="password" id="${isSignIn ? 'sign-in' : 'sign-up'}-password" placeholder="${t('auth_password')}" required class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <button type="submit" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-200" onclick="event.preventDefault(); handleAuth(${isSignIn})" data-lang-key="${isSignIn ? 'auth_sign_in' : 'auth_sign_up'}">${t(isSignIn ? 'auth_sign_in' : 'auth_sign_up')}</button>
                </form>
            `;
        }
        function renderProfileForm() {
            const p = state.userProfile;
            return `
                <form id="profile-form" class="space-y-3 p-4 border border-indigo-700/50 rounded-xl bg-gray-900/50">
                    <h4 class="text-lg font-bold text-indigo-200" data-lang-key="profile_title">${t('profile_title')}</h4>
                    <input type="text" id="profile-name" placeholder="${t('profile_name')}" value="${p.name}" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <input type="date" id="profile-dob" placeholder="${t('profile_dob')}" value="${p.dob}" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <input type="time" id="profile-tob" placeholder="${t('profile_tob')}" value="${p.tob}" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <input type="text" id="profile-city" placeholder="${t('profile_city')}" value="${p.city}" required class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <button type="submit" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition duration-200" onclick="event.preventDefault(); handleSaveProfile()" data-lang-key="profile_save">${t('profile_save')}</button>
                </form>
            `;
        }
        async function handleAuth(isSignIn) {
            const formId = isSignIn ? 'sign-in' : 'sign-up';
            const email = document.getElementById(`${formId}-email`).value;
            const password = document.getElementById(`${formId}-password`).value;
            if (!email || password.length < 6) {
                showModal('modal_error', 'auth_validation_fail', 'error');
                return;
            }
            try {
                showLoading(true);
                if (isSignIn) {
                    await signInWithEmailAndPassword(auth, email, password);
                    showModal('modal_success', 'auth_success_signin', 'info', {email: email});
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showModal('modal_success', 'auth_success_signup', 'info', {email: email});
                }
                closeModal(); 
            } catch (error) {
                let errorMessage = t('auth_fail');
                if (error.code) {
                    errorMessage = t('auth_fail_error', {error: error.code.replace('auth/', '').replace(/-/g, ' ').toUpperCase()});
                }
                showModal('modal_error', errorMessage, 'error');
            } finally {
                showLoading(false);
            }
        }
        async function handleSignOut() {
            await signOut(auth);
            state.userProfile = { name: '', dob: '', tob: '', city: '' }; 
            showModal('auth_signed_out', 'auth_signed_out_desc');
            // Auth listener will handle signing in anonymously next and re-render
        }
        function handleSaveProfile() {
            const name = document.getElementById('profile-name').value;
            const dob = document.getElementById('profile-dob').value;
            const tob = document.getElementById('profile-tob').value;
            const city = document.getElementById('profile-city').value;
            if (!dob || !tob || !city) {
                showModal('modal_validation_error', 'modal_validation_details', 'error');
                return;
            }
            const details = { name, dob, tob, city };
            saveUserProfile(details);
        }

        // --- RENDERING FUNCTIONS (VIEWS) ---
        function switchView(view) {
            state.currentView = view;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                const itemView = item.dataset.view;
                if (itemView === view) {
                    item.classList.add('font-bold');
                    item.classList.remove('text-gray-400', 'hover:text-indigo-300', 'hover:text-pink-300', 'hover:text-teal-300', 'hover:text-orange-300');
                    if(view === 'home') item.classList.add('text-indigo-400');
                    if(view === 'chart') item.classList.add('text-indigo-400');
                    if(view === 'health') item.classList.add('text-pink-400');
                    if(view === 'matching') item.classList.add('text-orange-400');
                    if(view === 'history') item.classList.add('text-teal-400');
                } else {
                    item.classList.remove('text-indigo-400', 'text-pink-400', 'text-teal-400', 'text-orange-400', 'font-bold');
                    item.classList.add('text-gray-400');
                    if(itemView === 'home') item.classList.add('hover:text-indigo-300');
                    if(itemView === 'chart') item.classList.add('hover:text-indigo-300');
                    if(itemView === 'health') item.classList.add('hover:text-pink-300');
                    if(itemView === 'matching') item.classList.add('hover:text-orange-300');
                    if(itemView === 'history') item.classList.add('hover:text-teal-300');
                }
            });
            renderCurrentView();
        }
        function renderCurrentView() {
            if (!isAuthReady || !db) {
                 console.error("RenderCurrentView called before Firebase was ready. This shouldn't happen.");
                 return;
            }
            switch (state.currentView) {
                case 'home':
                    renderHomePage();
                    break;
                case 'chart':
                    renderChartForm();
                    break;
                case 'health':
                    renderHealthForm();
                    break;
                case 'matching':
                    renderMatchingForm();
                    break;
                case 'history':
                    renderHistory();
                    break;
            }
        }
        function renderHomePage() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="text-center p-6 space-y-8">
                    <h2 class="text-4xl font-extrabold text-indigo-300" data-lang-key="home_welcome">${t('home_welcome')}</h2>
                    <div class="cosmic-hero mx-auto w-56 h-56 relative">
                        <svg viewBox="0 0 100 100" class="w-full h-full">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#3730A3" stroke-width="1"/>
                            <circle cx="50" cy="50" r="35" fill="none" stroke="#4F46E5" stroke-width="1.5" stroke-dasharray="1 3"/>
                            <circle cx="50" cy="50" r="8" fill="#FBBF24"/>
                            <circle cx="50" cy="50" r="25" fill="none" stroke="#6366F1" stroke-width="1" stroke-dasharray="3 5" class="animate-spin-slow"/>
                            <circle cx="25" cy="50" r="3" fill="#60A5FA" transform="rotate(45, 50, 50)">
                                <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="15s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="50" cy="50" r="40" fill="none" stroke="#818CF8" stroke-width="1.5" class="animate-spin-slow"/>
                            <circle cx="90" cy="50" r="4" fill="#A78BFA" transform="rotate(-30, 50, 50)">
                                <animateTransform attributeName="transform" type="rotate" from="360 50 50" to="0 50 50" dur="20s" repeatCount="indefinite"/>
                            </circle>
                            <polygon points="50,10 53,50 50,90 47,50" fill="#E0E7FF" transform="rotate(-15, 50, 50)">
                                <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="30s" repeatCount="indefinite"/>
                            </polygon>
                        </svg>
                    </div>
                    <div class="space-y-4">
                        <p class="text-lg text-gray-300 font-medium" data-lang-key="home_desc">${t('home_desc')}</p>
                        <p class="text-xl font-bold text-green-400" data-lang-key="home_free">${t('home_free')}</p>
                        <div class="p-4 bg-gray-800 rounded-xl text-left space-y-3 border border-indigo-700/50">
                            <h3 class="text-xl font-semibold text-indigo-400" data-lang-key="home_explore_title">${t('home_explore_title')}</h3>
                            <ul class="text-gray-300 space-y-2">
                                <li class="flex items-center"><span class="text-indigo-400 mr-3" data-lang-key="nav_chart">${t('nav_chart')}:</span> <span data-lang-key="home_explore_chart">${t('home_explore_chart')}</span></li>
                                <li class="flex items-center"><span class="text-pink-400 mr-3" data-lang-key="nav_health">${t('nav_health')}:</span> <span data-lang-key="home_explore_health">${t('home_explore_health')}</span></li>
                                <li class="flex items-center"><span class="text-orange-400 mr-3" data-lang-key="nav_matching">${t('nav_matching')}:</span> <span data-lang-key="home_explore_matching">${t('home_explore_matching')}</span></li>
                                <li class="flex items-center"><span class="text-teal-400 mr-3" data-lang-key="nav_history">${t('nav_history')}:</span> <span data-lang-key="home_explore_history">${t('home_explore_history')}</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }
        function getFormFields(formType, partnerId = '') {
            const p = (partnerId === 'p1' || (partnerId === '' && formType !== 'matching')) ? state.userProfile : { name: '', dob: '', tob: '', city: '' };
            const idPrefix = partnerId ? `${formType}-${partnerId}` : formType;

            return `
                <div class="space-y-3">
                    <input type="text" id="${idPrefix}-name" placeholder="${t('chart_name_placeholder')}" value="${p.name}" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                    <input type="date" id="${idPrefix}-dob" placeholder="${t('chart_dob_placeholder')}" value="${p.dob}" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                    <input type="time" id="${idPrefix}-tob" placeholder="${t('chart_tob_placeholder')}" value="${p.tob}" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                    <input type="text" id="${idPrefix}-city" placeholder="${t('chart_city_placeholder')}" value="${p.city}" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                    
                    ${formType === 'chart' ? `
                        <input type="number" id="chart-year" placeholder="${t('chart_year_placeholder')}" min="${new Date().getFullYear()}" max="${new Date().getFullYear() + 10}" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                         <p class="text-xs text-gray-500 mt-1" data-lang-key="chart_year_desc">${t('chart_year_desc')}</p>
                    ` : ''}
                    
                    ${formType === 'chart' || formType === 'health' ? `
                        <textarea id="${formType}-query" rows="3" placeholder="${t(formType === 'chart' ? 'chart_query_placeholder' : 'health_query_placeholder')}" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400"></textarea>
                        <p class="text-xs text-gray-500 mt-1" data-lang-key="${formType === 'chart' ? 'chart_query_desc' : 'health_query_desc'}">${t(formType === 'chart' ? 'chart_query_desc' : 'health_query_desc')}</p>
                    ` : ''}
                </div>
            `;
        }

        function renderChartForm() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-indigo-300 mb-6 border-b border-indigo-700/50 pb-2" data-lang-key="chart_title">${t('chart_title')}</h2>
                <form id="chart-form" class="bg-gray-800 p-5 rounded-2xl shadow-xl">
                    <p class="text-sm text-gray-400 mb-4" data-lang-key="chart_desc">${t('chart_desc')}</p>
                    ${getFormFields('chart')}
                    <button type="submit" class="w-full p-3 mt-5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-lg rounded-xl shadow-lg transition duration-200" data-lang-key="chart_button">${t('chart_button')}</button>
                </form>
                <div id="reading-output" class="mt-8"></div>
            `;
            document.getElementById('chart-form').addEventListener('submit', handleChartSubmit);
            state.currentReading = null; 
        }
        function renderHealthForm() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-pink-300 mb-6 border-b border-pink-700/50 pb-2" data-lang-key="health_title">${t('health_title')}</h2>
                <form id="health-form" class="bg-gray-800 p-5 rounded-2xl shadow-xl">
                    <p class="text-sm text-gray-400 mb-4" data-lang-key="health_desc">${t('health_desc')}</p>
                    ${getFormFields('health')}
                    <button type="submit" class="w-full p-3 mt-5 bg-pink-600 hover:bg-pink-700 text-white font-bold text-lg rounded-xl shadow-lg transition duration-200" data-lang-key="health_button">${t('health_button')}</button>
                </form>
                <div id="reading-output" class="mt-8"></div>
            `;
            document.getElementById('health-form').addEventListener('submit', handleHealthSubmit);
            state.currentReading = null;
        }
        
        function renderMatchingForm() {
             const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-orange-400 mb-6 border-b border-orange-700/50 pb-2" data-lang-key="matching_title">${t('matching_title')}</h2>
                <form id="matching-form" class="space-y-6">
                    <!-- Partner 1 -->
                    <div class="bg-gray-800 p-5 rounded-2xl shadow-xl border border-indigo-700/50">
                        <h3 class="text-xl font-bold text-indigo-300 mb-2" data-lang-key="matching_p1_title">${t('matching_p1_title')}</h3>
                        <p class="text-sm text-gray-400 mb-4" data-lang-key="matching_p1_desc">${t('matching_p1_desc')}</p>
                        ${getFormFields('matching', 'p1')}
                    </div>
                    
                    <!-- Partner 2 -->
                    <div class="bg-gray-800 p-5 rounded-2xl shadow-xl border border-gray-700">
                        <h3 class="text-xl font-bold text-gray-300 mb-2" data-lang-key="matching_p2_title">${t('matching_p2_title')}</h3>
                        <p class="text-sm text-gray-400 mb-4" data-lang-key="matching_p2_desc">${t('matching_p2_desc')}</p>
                        ${getFormFields('matching', 'p2')}
                    </div>
                    
                    <button type="submit" class="w-full p-3 mt-5 bg-orange-600 hover:bg-orange-700 text-white font-bold text-lg rounded-xl shadow-lg transition duration-200" data-lang-key="matching_button">${t('matching_button')}</button>
                </form>
                <div id="reading-output" class="mt-8"></div>
            `;
            document.getElementById('matching-form').addEventListener('submit', handleMatchingSubmit);
            state.currentReading = null;
        }

        function renderHistory() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-teal-300 mb-6 border-b border-teal-700/50 pb-2" data-lang-key="history_title">${t('history_title')}</h2>
                <p class="text-sm text-gray-400 mb-6" data-lang-key="history_desc">${t('history_desc')} <span class="font-bold block text-xs mt-1">${t('history_user_id')} ${userId}</span></p>
                <div id="history-list" class="space-y-4">
                    ${state.history.length === 0 ? `<p class="text-center text-gray-500" data-lang-key="history_empty">${t('history_empty')}</p>` : ''}
                </div>
            `;
            const historyList = document.getElementById('history-list');
            state.history.forEach(reading => {
                const isExpanded = reading.id === historyList.dataset.expandedId;
                const snippet = reading.content ? reading.content.substring(0, 150) + (reading.content.length > 150 ? '...' : '') : 'No content available.';
                
                let title;
                if(reading.type === 'matching') {
                    title = t('reading_title_matching');
                } else if (reading.year) {
                    title = t('reading_title_forecast', {year: reading.year});
                } else if (reading.type === 'health') {
                    title = t('reading_title_health');
                } else if (reading.userQuery) {
                    title = t('reading_title_query');
                } else {
                    title = t('reading_title_natal');
                }
                
                const subtitle = reading.userQuery ? t('reading_subtitle_query', {query: reading.userQuery}) : (reading.type ? t('reading_subtitle_type', {type: reading.type.toUpperCase()}) : 'CHART');
                const dateTime = reading.timestamp ? new Date(reading.timestamp).toLocaleString(currentLanguage) : 'Date unknown';
                const item = document.createElement('div');
                item.className = `bg-gray-800 rounded-xl shadow-lg border border-indigo-700/50 overflow-hidden cursor-pointer transition duration-300 hover:shadow-indigo-500/30`;
                
                let detailsHTML = '';
                if (reading.type === 'matching') {
                    detailsHTML = `
                        <p class="font-semibold text-indigo-400" data-lang-key="reading_details_p1">${t('reading_details_p1')}</p>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-400">
                            <div>${t('reading_details_name', {name: reading.birthDetails.name || 'N/A'})}</div>
                            <div>${t('reading_details_dob', {dob: reading.birthDetails.dob})}</div>
                            <div>${t('reading_details_tob', {tob: reading.birthDetails.tob})}</div>
                            <div>${t('reading_details_city', {city: reading.birthDetails.city})}</div>
                        </div>
                        <p class="font-semibold text-indigo-400 mt-2" data-lang-key="reading_details_p2">${t('reading_details_p2')}</p>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-400">
                            <div>${t('reading_details_name', {name: reading.p2Details.name || 'N/A'})}</div>
                            <div>${t('reading_details_dob', {dob: reading.p2Details.dob})}</div>
                            <div>${t('reading_details_tob', {tob: reading.p2Details.tob})}</div>
                            <div>${t('reading_details_city', {city: reading.p2Details.city})}</div>
                        </div>
                    `;
                } else {
                     detailsHTML = `
                        <p class="font-semibold text-indigo-400" data-lang-key="reading_details">${t('reading_details')}</p>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-400">
                            <div>${t('reading_details_name', {name: reading.birthDetails.name || 'N/A'})}</div>
                            <div>${t('reading_details_dob', {dob: reading.birthDetails.dob})}</div>
                            <div>${t('reading_details_tob', {tob: reading.birthDetails.tob})}</div>
                            <div>${t('reading_details_city', {city: reading.birthDetails.city})}</div>
                        </div>
                    `;
                }

                item.innerHTML = `
                    <div class="p-4 flex justify-between items-center" onclick="toggleHistoryExpansion('${reading.id}')">
                        <div>
                            <p class="font-bold text-indigo-300">${title}</p>
                            <p class="text-xs text-gray-400">${subtitle}</p>
                            <p class="text-xs text-gray-500 mt-1">${dateTime}</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    ${isExpanded ? `
                        <div class="p-4 pt-0 text-sm text-gray-300 bg-gray-900 border-t border-indigo-700/50 space-y-4">
                            ${detailsHTML}
                            <p class="font-semibold text-indigo-400 mt-4" data-lang-key="history_reading_title">${t('history_reading_title')}</p>
                            <div class="prose max-w-none text-gray-300" style="white-space: pre-wrap;">${reading.content || 'No content.'}</div>
                            ${reading.followUpContent ? `
                                <p class="font-semibold text-indigo-400 mt-4 border-t border-indigo-700/50 pt-4">${t('history_followup_title', {question: reading.followUpQuestion})}</p>
                                <div class="prose max-w-none text-gray-300" style="white-space: pre-wrap;">${reading.followUpContent}</div>
                            ` : ''}
                            <button onclick="deleteReading('${reading.id}')" class="mt-4 text-xs text-red-400 hover:text-red-500 transition duration-150" data-lang-key="history_delete_button">
                                ${t('history_delete_button')}
                            </button>
                        </div>
                    ` : `
                        <p class="p-4 pt-0 text-sm text-gray-400">${snippet}</p>
                    `}
                `;
                historyList.appendChild(item);
            });
        }
        function toggleHistoryExpansion(id) {
            const historyList = document.getElementById('history-list');
            if (historyList.dataset.expandedId === id) {
                historyList.dataset.expandedId = null;
            } else {
                historyList.dataset.expandedId = id;
            }
            renderHistory();
        }
        function renderReadingOutput(readingText) {
            const outputDiv = document.getElementById('reading-output');
            if (!outputDiv) return;
            outputDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-indigo-700/50 space-y-4">
                    <h3 class="text-2xl font-bold text-indigo-400 border-b border-indigo-500/50 pb-2">${state.currentReading.title}</h3>
                    <div class="prose max-w-none text-gray-300 space-y-4" style="white-space: pre-wrap;">${readingText}</div>
                    <div class="mt-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                        <h4 class="font-semibold text-indigo-300 mb-3" data-lang-key="output_followup_title">${t('output_followup_title')}</h4>
                        <textarea id="follow-up-query" rows="2" placeholder="${t('output_followup_placeholder')}" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400"></textarea>
                        <button class="mt-3 w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg transition duration-200" onclick="handleFollowUp()" data-lang-key="output_followup_button">${t('output_followup_button')}</button>
                    </div>
                </div>
            `;
        }
        function renderFollowUpOutput(query, answer) {
            const outputDiv = document.getElementById('reading-output');
            if (!outputDiv) return;
            const readingBlock = outputDiv.querySelector('.bg-gray-800');
            if (!readingBlock) return;
            const followUpForm = outputDiv.querySelector('.mt-6.p-4.bg-gray-900');
            if (followUpForm) followUpForm.remove();
            const followUpBlock = document.createElement('div');
            followUpBlock.className = 'mt-4 pt-4 border-t border-indigo-700/50 space-y-4';
            followUpBlock.innerHTML = `
                <p class="font-semibold text-indigo-400" data-lang-key="output_followup_question">${t('output_followup_question')}</p>
                <p class="italic text-gray-300">"${query}"</p>
                <p class="font-semibold text-indigo-400" data-lang-key="output_followup_response">${t('output_followup_response')}</p>
                <div class="prose max-w-none text-gray-300 space-y-4" style="white-space: pre-wrap;">${answer}</div>
            `;
            readingBlock.appendChild(followUpBlock);
        }

        // --- SUBMIT HANDLERS ---
        async function handleFollowUp() {
            const followUpQuery = document.getElementById('follow-up-query').value.trim();
            if (!followUpQuery) {
                showModal('modal_input_required', 'modal_follow_up_missing', 'error');
                return;
            }
            const currentReading = state.currentReading;
            if (!currentReading || !currentReading.content) {
                showModal('modal_error', 'modal_context_missing', 'error');
                return;
            }
            const readingData = { ...currentReading }; 
            const answer = await generateReading(
                currentReading.birthDetails,
                followUpQuery,
                currentReading.year,
                currentReading.type, 
                currentReading.content,
                readingData,
                currentReading.p2Details
            );
            if (answer) {
                renderFollowUpOutput(followUpQuery, answer);
                const combinedReading = {
                    ...readingData,
                    content: currentReading.content, 
                    followUpQuestion: followUpQuery,
                    followUpContent: answer,
                    title: currentReading.title + " (Follow-up)"
                };
                await saveReading(combinedReading);
                state.currentReading.followUpQuestion = followUpQuery;
                state.currentReading.followUpContent = answer;
            }
        }
        function getReadingData(formType, partnerId = null) {
            const idPrefix = partnerId ? `${formType}-${partnerId}` : formType;
            
            const name = document.getElementById(`${idPrefix}-name`).value.trim();
            const dob = document.getElementById(`${idPrefix}-dob`).value;
            const tob = document.getElementById(`${idPrefix}-tob`).value;
            const city = document.getElementById(`${idPrefix}-city`).value.trim();

            if (!dob || !tob || !city) {
                return null; // Will be caught by the submit handler
            }

            const birthDetails = { name, dob, tob, city };
            
            if (formType === 'matching') {
                return birthDetails; // Just return details for matching
            }

            // For chart/health
            const query = document.getElementById(`${formType}-query`).value.trim();
            const year = formType === 'chart' ? document.getElementById('chart-year').value.trim() : null;

            let title = '';
            if (formType === 'health') {
                title = t('reading_title_health');
            } else if (year) {
                title = t('reading_title_forecast', {year: year});
            } else if (query) {
                title = t('reading_title_query');
            } else {
                title = t('reading_title_natal');
            }
            return { birthDetails, query, year, type: formType, title };
        }

        async function handleChartSubmit(e) {
            e.preventDefault();
            const readingData = getReadingData('chart');
            if (!readingData) {
                showModal('modal_validation_error', 'modal_validation_details', 'error');
                return;
            }
            const { birthDetails, query, year, type, title } = readingData;
            const generatedText = await generateReading(birthDetails, query, year, type, null, readingData);
            if (generatedText) {
                renderReadingOutput(generatedText);
                await saveReading({ ...state.currentReading, userQuery: query || null });
            }
        }
        async function handleHealthSubmit(e) {
            e.preventDefault();
            const readingData = getReadingData('health');
            if (!readingData) {
                showModal('modal_validation_error', 'modal_validation_details', 'error');
                return;
            }
            const { birthDetails, query, type, title } = readingData;
            const generatedText = await generateReading(birthDetails, query, null, type, null, readingData);
            if (generatedText) {
                renderReadingOutput(generatedText);
                await saveReading({ ...state.currentReading, userQuery: query || null });
            }
        }
        
        async function handleMatchingSubmit(e) {
            e.preventDefault();
            const p1Details = getReadingData('matching', 'p1');
            const p2Details = getReadingData('matching', 'p2');

            if (!p1Details) {
                showModal('modal_validation_error', 'modal_validation_partner1', 'error');
                return;
            }
            if (!p2Details) {
                showModal('modal_validation_error', 'modal_validation_partner2', 'error');
                return;
            }

            const readingData = {
                birthDetails: p1Details,
                p2Details: p2Details,
                type: 'matching',
                title: t('reading_title_matching')
            };

            const generatedText = await generateReading(p1Details, null, null, 'matching', null, readingData, p2Details);
            
            if (generatedText) {
                renderReadingOutput(generatedText);
                await saveReading({ ...state.currentReading, content: generatedText });
            }
        }
        
        // --- INITIALIZATION ---
        
        // Mandated Global Variables Check
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // PASTE YOUR FIREBASE CONFIG OBJECT HERE
        const firebaseConfig = {
          apiKey: "AIzaSyD_hTndy6xst4f8hxAbJ42R9sX_82BMFdc",
          authDomain: "cosmic-compass-dbc12.firebaseapp.com",
          projectId: "cosmic-compass-dbc12",
          storageBucket: "cosmic-compass-dbc12.firebasestorage.app",
          messagingSenderId: "1077342508451",
          appId: "1:1077342508451:web:b3896f9add3003ba80f616",
          measurementId: "G-9QDKQVFJ1Y"
        };
        
        // We set initialAuthToken to null because it doesn't exist on Netlify
        const initialAuthToken = null; 

        // Check if the config has been filled
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE") {
            setLogLevel('debug'); // Enable Firestore logging for debugging
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. Initial Authentication and Listener Setup
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // Sign in anonymously if no user is found
                    try {
                        await signInAnonymously(auth);
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        // This is the error you were seeing: auth/configuration-not-found
                        // This MUST be fixed by ENABLING Anonymous Sign-In in your Firebase project.
                        document.getElementById('content-area').innerHTML = `<div class="text-center p-4 bg-red-900/50 border border-red-700 rounded-lg">
                            <h3 class="font-bold text-red-300 text-lg">${t('auth_error_anon_fail')}</h3>
                            <p class="text-red-200 mt-2">${t('auth_error_anon_fail_desc')}</p>
                        </div>`;
                        return; // Stop app initialization
                    }
                }
                
                isAuthReady = true;
                
                // Once authenticated, load user profile and set up history listener
                await loadUserProfile();
                setupHistoryListener();
                
                console.log("Firebase initialized. User ID:", userId);

                // *** THIS IS THE LOGIC FIX ***
                // ONLY render the initial view AFTER auth is confirmed.
                switchView('home'); 
            });

            // Handle the case where there is no pre-existing auth token
            if (!initialAuthToken && !auth.currentUser) {
                // Trigger anonymous sign-in immediately
                // The onAuthStateChanged listener will catch this.
                signInAnonymously(auth).catch(e => {
                    console.error("Initial anonymous sign-in trigger failed:", e);
                    // This error will be handled by the onAuthStateChanged listener's catch block
                });
            }
            
            // Add language selector listener
            document.getElementById('language-selector').addEventListener('change', (e) => {
                translateUI(e.target.value);
            });
            // Set initial language
            translateUI(currentLanguage);

        } else {
            console.error("Firebase config is missing. Please paste your Firebase project config into index.html.");
            // If Firebase is missing, show a clear error.
            document.getElementById('content-area').innerHTML = `<div class="text-center p-4 bg-red-900/50 border border-red-700 rounded-lg">
                <h3 class="font-bold text-red-300 text-lg">${t('auth_error_config_missing')}</h3>
                <p class="text-red-200 mt-2">${t('auth_error_config_missing_desc')}</p>
            </div>`;
        }

    </script>
</body>
</html>