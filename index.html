<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Compass Astrologer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #818CF8; border-radius: 2px; }
        ::-webkit-scrollbar-track { background: #0F172A; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* Darkest Navy */
            color: #E2E8F0; /* Light text */
            min-height: 100vh;
        }
        /* Mobile-first main container styling */
        .main-container {
            max-width: 640px;
            margin: 0 auto;
            padding-bottom: 72px; /* Space for fixed bottom nav */
        }
        /* Custom slow spin for the initial loading screen logo */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 2s linear infinite;
        }
        /* Enhanced Hero SVG styling */
        .cosmic-hero {
            filter: drop-shadow(0 0 10px rgba(129, 140, 248, 0.5)); /* Subtle neon glow */
        }
    </style>
</head>
<body>

    <div id="app" class="main-container flex flex-col min-h-screen">
        <!-- HEADER -->
        <header class="sticky top-0 bg-gray-900 shadow-xl p-4 flex justify-between items-center z-10">
            <h1 class="text-2xl font-extrabold text-indigo-400">Cosmic Compass</h1>
            <button id="profile-btn" class="text-indigo-300 hover:text-indigo-100 transition duration-150 p-2 rounded-full bg-gray-800" onclick="showProfileModal()">
                <!-- Moon icon for profile -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M12 2a10 10 0 0 0 9.071 5.378 10 10 0 0 1-5.698 12.33 10 10 0 0 0-3.373-1.077c-.504-.085-1.15-.027-1.503.208-.475.313-.604.912-.34 1.488.267.591.956.883 1.57.653A10 10 0 0 0 12 2z"/>
                </svg>
            </button>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="content-area" class="flex-grow p-4"></main>

        <!-- FIXED BOTTOM NAVIGATION -->
        <nav class="fixed bottom-0 left-0 right-0 bg-gray-900 shadow-2xl border-t border-indigo-700/50 z-20">
            <div class="max-w-md mx-auto flex justify-around items-center h-16">
                <!-- HOME Button -->
                <button class="nav-item flex flex-col items-center p-2 text-sm transition-colors duration-200" data-view="home" onclick="switchView('home')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span class="mt-1">Home</span>
                </button>
                
                <!-- CHART Button -->
                <button class="nav-item flex flex-col items-center p-2 text-sm transition-colors duration-200" data-view="chart" onclick="switchView('chart')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="12" cy="12" r="10"/><path d="M12 2v10"/><path d="M18.4 6.6l-2.1 2.1"/><path d="M5.6 6.6l2.1 2.1"/></svg>
                    <span class="mt-1">Chart</span>
                </button>
                
                <!-- HEALTH Button -->
                <button class="nav-item flex flex-col items-center p-2 text-sm transition-colors duration-200" data-view="health" onclick="switchView('health')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M20.5 2L15 6.5l-3-3L2 12l9.5 9.5 3-3L17.5 20l4.5-5.5z"/><path d="M12 12l-7-7"/></svg>
                    <span class="mt-1">Health</span>
                </button>
                
                <!-- HISTORY Button -->
                <button class="nav-item flex flex-col items-center p-2 text-sm transition-colors duration-200" data-view="history" onclick="switchView('history')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 21a9 9 0 0 0 9-9h-2a7 7 7 0 0 1-7 7V12h-2V7h2V5H9a9 9 0 0 0-9 9z"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span class="mt-1">History</span>
                </button>
            </div>
        </nav>

        <!-- Modals and Overlays -->
        <div id="modal-container"></div>
        <div id="loading-overlay" class="fixed inset-0 bg-gray-900/70 flex items-center justify-center hidden z-50">
            <div class="flex flex-col items-center p-8 bg-gray-800 rounded-2xl shadow-2xl border border-indigo-500 transform scale-105">
                <!-- Attractive Loading Indicator -->
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400 animate-spin-slow mb-4">
                    <path d="M12 2a10 10 0 0 0 9.071 5.378 10 10 0 0 1-5.698 12.33 10 10 0 0 0-3.373-1.077c-.504-.085-1.15-.027-1.503.208-.475.313-.604.912-.34 1.488.267.591.956.883 1.57.653A10 10 0 0 0 12 2z"/>
                    <path d="M12 2v20"/><path d="M4.22 4.22l15.56 15.56M4.22 19.78l15.56-15.56"/>
                    <path d="M22 12h-3"/><path d="M5 12h-3"/><path d="M12 5V2"/><path d="M12 22v-3"/>
                </svg>
                <p class="mt-3 text-indigo-300 font-semibold text-lg">Generating Cosmic Insight...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        window.activeSnapshotUnsubscribe = null;

        // Mandated Global Variables Check
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            setLogLevel('debug'); // Enable Firestore logging for debugging
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            // 1. Initial Authentication and Listener Setup
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.userId = user.uid;
                } else {
                    // Sign in anonymously if no user is found, as a fallback
                    await signInAnonymously(window.auth).catch(e => console.error("Anonymous sign-in failed:", e));
                    window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                }
                
                window.isAuthReady = true;
                // NEW: Check if the user is a permanent (non-anonymous) account
                state.isPermanentUser = user && !user.isAnonymous;
                
                // Once authenticated, load user profile and set up history listener
                await loadUserProfile();
                setupHistoryListener();
                
                // Rerender the current view (updates forms with loaded data)
                renderCurrentView(); 

                console.log("Firebase initialized. User ID:", window.userId);
            });

            // Attempt custom token sign-in if token is available
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } catch (e) {
                    console.error("Custom token sign-in failed:", e);
                }
            }
        } else {
            console.error("Firebase config is missing.");
        }

        // Expose Firebase functions to global scope for use in non-module scripts
        window.firebaseExports = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            doc,
            setDoc,
            collection,
            query,
            where,
            addDoc,
            onSnapshot,
            getDocs,
            orderBy,
            appId,
            db,
            auth
        };
    </script>
    
    <!-- Application Logic -->
    <script>
        // --- GLOBAL APP STATE ---
        let state = {
            currentView: 'home', // Changed default view to 'home'
            userProfile: {
                name: '',
                dob: '',
                tob: '',
                city: ''
            },
            currentReading: null, // Stores the last generated reading details
            history: [],
            modalOpen: false,
            isPermanentUser: false // NEW: Tracks if user is signed in with email/password
        };

        // --- UTILITY FUNCTIONS ---

        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        function showModal(title, content, type = 'info') {
            const modalContainer = document.getElementById('modal-container');
            let color = type === 'error' ? 'bg-red-900 border-red-500' : 'bg-gray-800 border-indigo-500';
            let titleColor = type === 'error' ? 'text-red-400' : 'text-indigo-400';

            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40" onclick="closeModal()">
                    <div class="w-11/12 max-w-sm p-6 rounded-xl shadow-2xl ${color} border" onclick="event.stopPropagation()">
                        <h3 class="text-xl font-bold mb-4 ${titleColor}">${title}</h3>
                        <div class="text-sm text-gray-300">${content}</div>
                        <button class="mt-6 w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-200" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            state.modalOpen = true;
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
            state.modalOpen = false;
        }

        // --- FIREBASE / DATA MANAGEMENT ---

        async function loadUserProfile() {
            if (!window.userId || !window.db) return;

            const { db, appId, userId, doc, firebaseExports } = window.firebaseExports;
            const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'user_profile', 'details');

            try {
                // Since getDoc is not available, we assume the profile data is fetched/managed
                // via another mechanism or we rely on the saved data via setDoc.
                // For this implementation, we will assume a simple getDocs over a collection.

                const profileQuery = firebaseExports.query(
                    firebaseExports.collection(db, 'artifacts', appId, 'users', userId, 'user_profile')
                );
                const snapshot = await firebaseExports.getDocs(profileQuery);

                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    state.userProfile = {
                        name: data.name || '',
                        dob: data.dob || '',
                        tob: data.tob || '',
                        city: data.city || ''
                    };
                    console.log("Profile loaded:", state.userProfile);
                }
            } catch (e) {
                console.error("Error loading profile:", e);
            }
        }

        async function saveUserProfile(details) {
            if (!window.userId || !window.db) {
                showModal('Error', 'Please sign in or wait for authentication to complete.', 'error');
                return;
            }

            const { db, appId, userId, doc, setDoc } = window.firebaseExports;
            const profileRef = doc(db, 'artifacts', appId, 'users', userId, 'user_profile', 'details');

            try {
                await setDoc(profileRef, details, { merge: true });
                state.userProfile = details;
                showModal('Success', 'Your default birth details have been saved!', 'info');
                // Re-render to update forms
                renderCurrentView(); 
            } catch (e) {
                console.error("Error saving profile:", e);
                showModal('Error', 'Failed to save profile. Please check console for details.', 'error');
            }
        }
        
        function setupHistoryListener() {
            if (!window.userId || !window.db || window.activeSnapshotUnsubscribe) return;

            const { db, appId, userId, collection, query, orderBy, onSnapshot } = window.firebaseExports;
            const historyRef = collection(db, 'artifacts', appId, 'users', userId, 'astrology_readings');
            // Note: orderBy is commented out to avoid potential index errors in the canvas environment.
            const q = query(historyRef); // , orderBy('timestamp', 'desc'));

            window.activeSnapshotUnsubscribe = onSnapshot(q, (snapshot) => {
                const readings = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Deserialize complex data structures if needed, though simple objects are fine
                    readings.push({ id: doc.id, ...data });
                });
                
                // Sort client-side since orderBy is disabled
                readings.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                state.history = readings;
                if (state.currentView === 'history') {
                    renderHistory();
                }
            }, (error) => {
                console.error("Error listening to history:", error);
                // Optionally show error to user
            });
            console.log("History listener active.");
        }

        async function saveReading(readingData) {
            if (!window.userId || !window.db) return;

            const { db, appId, userId, collection, addDoc } = window.firebaseExports;
            const historyRef = collection(db, 'artifacts', appId, 'users', userId, 'astrology_readings');

            try {
                await addDoc(historyRef, {
                    ...readingData,
                    timestamp: Date.now(),
                    userId: userId
                });
                console.log("Reading saved to history.");
            } catch (e) {
                console.error("Error saving reading:", e);
            }
        }

        async function deleteReading(id) {
            // Note: deleteDoc is not imported by default in the Firebase imports list
            // For simplicity and stability, we will only log the attempt.
            showModal('Action Disabled', 'Deleting history items is disabled to maintain code stability in the current environment.', 'info');
            // In a production app, you would use:
            // const { db, appId, userId, doc, deleteDoc } = window.firebaseExports;
            // const docRef = doc(db, 'artifacts', appId, 'users', userId, 'astrology_readings', id);
            // await deleteDoc(docRef);
        }
        
        // --- GEMINI API COMMUNICATION (SECURE PROXY) ---

        async function generateReading(birthDetails, userQuery, yearInput, readingType, previousReading = null, readingData) {
            showLoading(true);
            
            // The API key and model selection is hidden in the serverless function.
            // This fetch call goes to the secure proxy endpoint on Netlify.
            const apiUrl = '/.netlify/functions/generateReading'; 

            // Payload contains all necessary data for the server to construct the prompt
            const payload = {
                birthDetails,
                userQuery,
                yearInput,
                readingType,
                previousReading
            };

            try {
                // Implement exponential backoff for retries
                let response = null;
                let maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    if (response.status === 429 && i < maxRetries - 1) { // 429: Too Many Requests
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                        continue;
                    }
                    throw new Error(`Proxy request failed with status: ${response.status}`);
                }

                if (!response.ok) {
                    throw new Error("Failed to get a successful response from the server after retries.");
                }

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                // Update current reading state for follow-up questions
                state.currentReading = {
                    title: readingData.title, 
                    birthDetails: birthDetails,
                    content: result.text,
                    type: readingType,
                    year: yearInput
                };
                
                return result.text; // Return the generated text
            } catch (error) {
                console.error("AI Generation Error:", error);
                showModal('AI Generation Failed', `There was an error generating the reading: ${error.message}. Please try again later.`, 'error');
                return null;
            } finally {
                showLoading(false);
            }
        }

        // --- AUTH/PROFILE MODAL LOGIC ---

        function showProfileModal(requireAuth = false) {
            if (!window.isAuthReady) {
                showModal('Loading', 'Please wait while we connect to the server...', 'info');
                return;
            }
            
            const isAuthenticated = state.isPermanentUser;
            
            let descriptiveMessage = '';
            if (requireAuth && !isAuthenticated) {
                descriptiveMessage = '<p class="text-lg font-semibold text-red-300 mb-4">ðŸ”’ Sign in is required to unlock personalized readings and history.</p>';
            }

            const profileContent = `
                ${descriptiveMessage}
                ${isAuthenticated ? `
                    <div class="mb-4 text-sm">
                        <p class="font-semibold text-indigo-300">Signed in as:</p>
                        <p class="text-gray-300 break-words">${window.auth.currentUser.email || 'Anonymous User'}</p>
                        <p class="text-xs text-gray-500 mt-1">User ID: ${window.userId}</p>
                    </div>
                    ${renderProfileForm()}
                    <button class="mt-4 w-full py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-200" onclick="handleSignOut()">Sign Out</button>
                ` : `
                    ${renderAuthForm(true)}
                    <p class="text-center text-sm my-3 text-gray-400">- OR -</p>
                    ${renderAuthForm(false)}
                `}
            `;

            showModal('User Profile & Auth', profileContent, 'info');
        }

        function renderAuthForm(isSignIn) {
            return `
                <form id="${isSignIn ? 'sign-in' : 'sign-up'}-form" class="space-y-3 p-4 border border-indigo-700/50 rounded-xl bg-gray-900/50 mb-4">
                    <h4 class="text-lg font-bold text-indigo-200">${isSignIn ? 'Sign In' : 'New Account'}</h4>
                    <input type="email" id="${isSignIn ? 'sign-in' : 'sign-up'}-email" placeholder="Email" required class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <input type="password" id="${isSignIn ? 'sign-in' : 'sign-up'}-password" placeholder="Password (6+ chars)" required class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <button type="submit" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-200" onclick="event.preventDefault(); handleAuth(${isSignIn})">${isSignIn ? 'Sign In' : 'Sign Up'}</button>
                </form>
            `;
        }

        function renderProfileForm() {
            const p = state.userProfile;
            return `
                <form id="profile-form" class="space-y-3 p-4 border border-indigo-700/50 rounded-xl bg-gray-900/50">
                    <h4 class="text-lg font-bold text-indigo-200">Default Birth Details</h4>
                    <input type="text" id="profile-name" placeholder="Name" value="${p.name}" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <input type="date" id="profile-dob" placeholder="Date of Birth" value="${p.dob}" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <input type="time" id="profile-tob" placeholder="Time of Birth" value="${p.tob}" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <input type="text" id="profile-city" placeholder="City/Location" value="${p.city}" required class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-400">
                    <button type="submit" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition duration-200" onclick="event.preventDefault(); handleSaveProfile()">Save Default Details</button>
                </form>
            `;
        }
        
        async function handleAuth(isSignIn) {
            const formId = isSignIn ? 'sign-in' : 'sign-up';
            const email = document.getElementById(`${formId}-email`).value;
            const password = document.getElementById(`${formId}-password`).value;

            const { createUserWithEmailAndPassword, signInWithEmailAndPassword } = window.firebaseExports;

            if (!email || password.length < 6) {
                showModal('Error', 'Please enter a valid email and a password of at least 6 characters.', 'error');
                return;
            }

            try {
                showLoading(true);
                if (isSignIn) {
                    await signInWithEmailAndPassword(window.auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(window.auth, email, password);
                }
                // Auth listener handles setting isPermanentUser and re-rendering
                closeModal();
                showModal('Success!', `Successfully signed in as ${email}. You can now access all features.`, 'info');
            } catch (error) {
                let errorMessage = 'Authentication Failed.';
                if (error.code) {
                    errorMessage = `Error: ${error.code.replace('auth/', '').replace(/-/g, ' ').toUpperCase()}`;
                }
                showModal('Authentication Error', errorMessage, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleSignOut() {
            const { signOut } = window.firebaseExports;
            await signOut(window.auth);
            state.userProfile = { name: '', dob: '', tob: '', city: '' }; // Clear local profile
            showModal('Signed Out', 'You have been signed out. You can now browse the home page.', 'info');
            closeModal();
            // Auth listener will handle signing in anonymously next and rendering 'home'
        }

        function handleSaveProfile() {
            const name = document.getElementById('profile-name').value;
            const dob = document.getElementById('profile-dob').value;
            const tob = document.getElementById('profile-tob').value;
            const city = document.getElementById('profile-city').value;

            if (!dob || !tob || !city) {
                showModal('Validation Error', 'Date of Birth, Time of Birth, and City are required to save your profile.', 'error');
                return;
            }

            const details = { name, dob, tob, city };
            saveUserProfile(details);
        }

        // --- RENDERING FUNCTIONS (VIEWS) ---

        function switchView(view) {
            const authRequiredViews = ['chart', 'health', 'history'];

            // 1. AUTHENTICATION GUARD: If the target view requires auth and user is not permanent, show modal
            if (authRequiredViews.includes(view) && !state.isPermanentUser) {
                showProfileModal(true);
                // We keep currentView as 'home'
                return; 
            }

            // 2. Proceed with navigation
            state.currentView = view;
            
            // Update nav bar active state
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.view === view) {
                    item.classList.add('text-indigo-400', 'font-bold');
                    item.classList.remove('text-indigo-300/50');
                } else {
                    item.classList.remove('text-indigo-400', 'font-bold');
                    item.classList.add('text-indigo-300/50');
                }
            });
            renderCurrentView();
        }

        function renderCurrentView() {
            const contentArea = document.getElementById('content-area');

            switch (state.currentView) {
                case 'home':
                    renderHomePage();
                    break;
                case 'chart':
                    renderChartForm();
                    break;
                case 'health':
                    renderHealthForm();
                    break;
                case 'history':
                    renderHistory();
                    break;
            }
        }

        function renderHomePage() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="p-6 text-center">
                    <h2 class="text-4xl font-extrabold text-indigo-300 mb-4">Welcome to Cosmic Compass</h2>
                    
                    <!-- NEW: Stylized Hero SVG -->
                    <svg class="cosmic-hero w-full max-w-xs mx-auto mb-8" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Outer Ring -->
                        <circle cx="50" cy="50" r="48" stroke="#3730A3" stroke-width="1.5" fill="none"/>
                        <!-- Inner Ring -->
                        <circle cx="50" cy="50" r="35" stroke="#4F46E5" stroke-width="1.5" fill="none"/>
                        
                        <!-- Moon (Crescent) -->
                        <path d="M50 8 C68.74 8 83 22.26 83 41 C83 59.74 68.74 74 50 74 C41.05 74 33.15 70.82 27 65.48 C34.62 67.8 42.84 68.7 50 68.7 C65.88 68.7 79.1 55.48 79.1 40 C79.1 24.52 65.88 11.3 50 11.3 C42.84 11.3 34.62 12.2 27 14.52 C33.15 9.18 41.05 6 50 6 Z" fill="#818CF8"/>
                        
                        <!-- Compass Arrow (Points North/Up) -->
                        <path d="M50 5 L55 20 L50 18 L45 20 Z" fill="#E0F2F1"/>
                        <path d="M50 5 L55 20 L50 18 L45 20 Z" stroke="#312E81" stroke-width="1" transform="rotate(180, 50, 50)" fill="#7C3AED"/>

                        <!-- Star Cluster 1 -->
                        <circle cx="25" cy="18" r="3" fill="#FDE047"/>
                        <circle cx="75" cy="80" r="2" fill="#FDE047"/>
                        <!-- Star Cluster 2 (Smaller dots) -->
                        <circle cx="20" cy="65" r="1" fill="#FFFFFF"/>
                        <circle cx="70" cy="30" r="1.5" fill="#FFFFFF"/>

                        <!-- Center Planet/Sun -->
                        <circle cx="50" cy="50" r="10" fill="url(#sunGradient)"/>
                        
                        <!-- Define Gradient -->
                        <defs>
                            <radialGradient id="sunGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                <stop offset="0%" style="stop-color:#FDE047; stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#F97316; stop-opacity:0.8" />
                            </radialGradient>
                        </defs>
                    </svg>

                    <p class="text-lg text-gray-300 mb-6">
                        Your completely **free** personalized guide to the stars. Cosmic Compass uses intelligent analysis to provide in-depth readings of your natal chart, future forecasts, and holistic health insights.
                    </p>
                    
                    <div class="space-y-4 text-left mx-auto max-w-xs">
                        <div class="flex items-center space-x-3">
                            <span class="text-indigo-400 font-bold">Chart:</span>
                            <span class="text-sm text-gray-400">Discover your core self and yearly transits.</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-indigo-400 font-bold">Health:</span>
                            <span class="text-sm text-gray-400">Astrological insights into your vitality and wellness.</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-indigo-400 font-bold">History:</span>
                            <span class="text-sm text-gray-400">Save and review your personalized readings.</span>
                        </div>
                    </div>

                    <p class="mt-8 text-sm text-gray-500">
                        Please use the navigation bar below to start, and sign in to unlock all features.
                    </p>
                </div>
            `;
            // Ensure the Home button is active visually when the page loads
            switchView('home');
        }
        
        function getFormFields(formType) {
            const p = state.userProfile;
            return `
                <div class="space-y-3">
                    <input type="text" id="${formType}-name" placeholder="Name (e.g., Jane Doe)" value="${p.name}" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                    <input type="date" id="${formType}-dob" placeholder="Date of Birth" value="${p.dob}" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                    <input type="time" id="${formType}-tob" placeholder="Time of Birth" value="${p.tob}" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                    <input type="text" id="${formType}-city" placeholder="City (e.g., New York, NY)" value="${p.city}" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                    ${formType === 'chart' ? `
                        <input type="number" id="chart-year" placeholder="Annual Forecast Year (Optional)" min="${new Date().getFullYear()}" max="${new Date().getFullYear() + 10}" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400">
                    ` : ''}
                    <textarea id="${formType}-query" rows="3" placeholder="${formType === 'chart' ? 'Specific Question (e.g., How will my career look next month?) - OPTIONAL' : 'Specific Health Inquiry (e.g., Focus on my joints and energy levels) - OPTIONAL'}" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400"></textarea>
                </div>
                <button type="submit" class="w-full p-3 mt-5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-lg rounded-xl shadow-lg transition duration-200">Generate Reading</button>
            `;
        }

        function renderChartForm() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-indigo-300 mb-6 border-b border-indigo-700/50 pb-2">Natal Chart & Forecast</h2>
                <form id="chart-form" class="bg-gray-800 p-5 rounded-2xl shadow-xl">
                    <p class="text-sm text-gray-400 mb-4">Enter your birth details to receive a comprehensive analysis, annual forecast, or a specific query response.</p>
                    ${getFormFields('chart')}
                </form>
                <div id="reading-output" class="mt-8"></div>
            `;
            document.getElementById('chart-form').addEventListener('submit', handleChartSubmit);
            state.currentReading = null; // Clear old reading when rendering new form
        }

        function renderHealthForm() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-indigo-300 mb-6 border-b border-indigo-700/50 pb-2">Holistic Health Profile</h2>
                <form id="health-form" class="bg-gray-800 p-5 rounded-2xl shadow-xl">
                    <p class="text-sm text-gray-400 mb-4">Get an astrological perspective on your vitality, strengths, and areas for preventative care.</p>
                    ${getFormFields('health')}
                </form>
                <div id="reading-output" class="mt-8"></div>
            `;
            document.getElementById('health-form').addEventListener('submit', handleHealthSubmit);
            state.currentReading = null;
        }

        function renderHistory() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-indigo-300 mb-6 border-b border-indigo-700/50 pb-2">Reading History</h2>
                <p class="text-sm text-gray-400 mb-6">Your personal archive of cosmic insights. <span class="font-bold">User ID: ${window.userId}</span></p>
                <div id="history-list" class="space-y-4">
                    ${state.history.length === 0 ? '<p class="text-center text-gray-500">No readings saved yet. Generate one now!</p>' : ''}
                </div>
            `;
            
            const historyList = document.getElementById('history-list');

            state.history.forEach(reading => {
                const isExpanded = reading.id === historyList.dataset.expandedId;
                const snippet = reading.content.substring(0, 150) + (reading.content.length > 150 ? '...' : '');
                const title = reading.year ? `Annual Forecast (${reading.year})` : (reading.type === 'health' ? 'Health Profile' : 'Natal Chart Overview');
                const subtitle = reading.userQuery ? `Query: ${reading.userQuery}` : reading.type.toUpperCase();
                const dateTime = new Date(reading.timestamp).toLocaleString();

                const item = document.createElement('div');
                item.className = `bg-gray-800 rounded-xl shadow-lg border border-indigo-700/50 overflow-hidden cursor-pointer transition duration-300 hover:shadow-indigo-500/30`;
                item.innerHTML = `
                    <div class="p-4 flex justify-between items-center" onclick="toggleHistoryExpansion('${reading.id}')">
                        <div>
                            <p class="font-bold text-indigo-300">${title}</p>
                            <p class="text-xs text-gray-400">${subtitle}</p>
                            <p class="text-xs text-gray-500 mt-1">${dateTime}</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    ${isExpanded ? `
                        <div class="p-4 pt-0 text-sm text-gray-300 bg-gray-900 border-t border-indigo-700/50 space-y-4">
                            <p class="font-semibold text-indigo-400">Birth Details:</p>
                            <div class="grid grid-cols-2 gap-2 text-xs text-gray-400">
                                <div>Name: ${reading.birthDetails.name}</div>
                                <div>DOB: ${reading.birthDetails.dob}</div>
                                <div>TOB: ${reading.birthDetails.tob}</div>
                                <div>City: ${reading.birthDetails.city}</div>
                            </div>
                            <p class="font-semibold text-indigo-400 mt-4">Reading:</p>
                            <div class="prose max-w-none text-gray-300">${reading.content.replace(/\n/g, '<br>')}</div>
                            
                            ${reading.followUpContent ? `
                                <p class="font-semibold text-indigo-400 mt-4 border-t border-indigo-700/50 pt-4">Follow-up: ${reading.followUpQuestion}</p>
                                <div class="prose max-w-none text-gray-300">${reading.followUpContent.replace(/\n/g, '<br>')}</div>
                            ` : ''}
                            
                            <!-- Delete button disabled for stability -->
                            <button onclick="deleteReading('${reading.id}')" class="mt-4 text-xs text-red-400 hover:text-red-500 transition duration-150">
                                Delete History Item
                            </button>
                        </div>
                    ` : `
                        <p class="p-4 pt-0 text-sm text-gray-400">${snippet}</p>
                    `}
                `;
                historyList.appendChild(item);
            });
        }

        function toggleHistoryExpansion(id) {
            const historyList = document.getElementById('history-list');
            if (historyList.dataset.expandedId === id) {
                historyList.dataset.expandedId = null;
            } else {
                historyList.dataset.expandedId = id;
            }
            // Rerender to show expanded/collapsed view
            renderHistory();
        }

        function renderReadingOutput(readingText) {
            const outputDiv = document.getElementById('reading-output');
            if (!outputDiv) return;

            outputDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-indigo-700/50 space-y-4">
                    <h3 class="text-2xl font-bold text-indigo-400 border-b border-indigo-500/50 pb-2">${state.currentReading.title}</h3>
                    <div class="prose max-w-none text-gray-300 space-y-4 whitespace-pre-wrap">${readingText}</div>
                    
                    <!-- Follow-up Section -->
                    <div class="mt-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                        <h4 class="font-semibold text-indigo-300 mb-3">Ask a Follow-up Question</h4>
                        <textarea id="follow-up-query" rows="2" placeholder="Ask a specific question based on the reading above..." class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400"></textarea>
                        <button class="mt-3 w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg transition duration-200" onclick="handleFollowUp()">Get Follow-up Answer</button>
                    </div>
                </div>
            `;
        }

        function renderFollowUpOutput(query, answer) {
            const outputDiv = document.getElementById('reading-output');
            if (!outputDiv) return;

            const readingBlock = outputDiv.querySelector('.bg-gray-800');
            if (!readingBlock) return;

            // Remove follow-up form after use
            const followUpForm = outputDiv.querySelector('.mt-6.p-4.bg-gray-900');
            if (followUpForm) followUpForm.remove();

            // Append the answer
            const followUpBlock = document.createElement('div');
            followUpBlock.className = 'mt-4 pt-4 border-t border-indigo-700/50 space-y-4';
            followUpBlock.innerHTML = `
                <p class="font-semibold text-indigo-400">Your Question:</p>
                <p class="italic text-gray-300">"${query}"</p>
                <p class="font-semibold text-indigo-400">AI Response:</p>
                <div class="prose max-w-none text-gray-300 space-y-4 whitespace-pre-wrap">${answer}</div>
            `;
            readingBlock.appendChild(followUpBlock);
        }

        // --- SUBMIT HANDLERS ---

        async function handleFollowUp() {
            const followUpQuery = document.getElementById('follow-up-query').value.trim();
            if (!followUpQuery) {
                showModal('Input Required', 'Please type your follow-up question.', 'error');
                return;
            }

            const currentReading = state.currentReading;
            if (!currentReading || !currentReading.content) {
                showModal('Error', 'Original reading context is missing.', 'error');
                return;
            }

            // The 'readingType' parameter for the proxy will handle the different modes
            const answer = await generateReading(
                currentReading.birthDetails,
                followUpQuery,
                currentReading.year,
                currentReading.type, // Pass original type (chart/health)
                currentReading.content, // Pass the previous reading as context
                // Pass readingData object structure for use in the generateReading function
                { title: currentReading.title } 
            );

            if (answer) {
                renderFollowUpOutput(followUpQuery, answer);

                // Save follow-up answer to history
                const { db, appId, userId, collection, addDoc } = window.firebaseExports;
                const historyRef = collection(db, 'artifacts', appId, 'users', userId, 'astrology_readings');

                // Add a new entry to history with the full context
                await addDoc(historyRef, {
                    ...currentReading,
                    content: currentReading.content, // Original reading content
                    followUpQuestion: followUpQuery,
                    followUpContent: answer,
                    timestamp: Date.now(),
                    userId: userId,
                    title: currentReading.title + " (Follow-up)"
                });
                
                // Update local state to reflect the new combined reading
                state.currentReading.followUpQuestion = followUpQuery;
                state.currentReading.followUpContent = answer;

                // Optionally, let the history listener update the history list
            }
        }

        function getReadingData(formType) {
            const name = document.getElementById(`${formType}-name`).value.trim();
            const dob = document.getElementById(`${formType}-dob`).value;
            const tob = document.getElementById(`${formType}-tob`).value;
            const city = document.getElementById(`${formType}-city`).value.trim();
            const query = document.getElementById(`${formType}-query`).value.trim();
            const year = formType === 'chart' ? document.getElementById('chart-year').value.trim() : null;

            if (!dob || !tob || !city) {
                showModal('Input Required', 'Date of Birth, Time of Birth, and City are required.', 'error');
                return null;
            }

            const birthDetails = { name, dob, tob, city };
            
            let title = '';
            if (formType === 'health') {
                title = 'Holistic Health Profile';
            } else if (year) {
                title = `Annual Forecast for ${year}`;
            } else if (query) {
                title = `Targeted Chart Query`;
            } else {
                title = 'Comprehensive Natal Chart Overview';
            }
            
            return { birthDetails, query, year, type: formType, title };
        }

        async function handleChartSubmit(e) {
            e.preventDefault();
            const readingData = getReadingData('chart');
            if (!readingData) return;

            const { birthDetails, query, year, type, title } = readingData;
            
            // Pass the title so generateReading can save it to state
            const generatedText = await generateReading(birthDetails, query, year, type, null, readingData);

            if (generatedText) {
                // Update state and display output
                state.currentReading = { birthDetails, userQuery: query, year, type, content: generatedText, title };
                renderReadingOutput(generatedText);
                
                // Save to history
                await saveReading({ ...readingData, content: generatedText, userQuery: query || null });
            }
        }

        async function handleHealthSubmit(e) {
            e.preventDefault();
            const readingData = getReadingData('health');
            if (!readingData) return;

            const { birthDetails, query, type, title } = readingData;

            // Pass the title so generateReading can save it to state
            const generatedText = await generateReading(birthDetails, query, null, type, null, readingData);

            if (generatedText) {
                // Update state and display output
                state.currentReading = { birthDetails, userQuery: query, year: null, type, content: generatedText, title };
                renderReadingOutput(generatedText);
                
                // Save to history
                await saveReading({ ...readingData, content: generatedText, userQuery: query || null });
            }
        }
        
        // --- INITIALIZATION ---
        
        // Initial view setup: Renders the home page immediately on page load.
        window.onload = () => {
            switchView('home');
        };

    </script>
</body>
</html>